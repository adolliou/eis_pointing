# EIS pointing

Tools to correct the pointing of Hinode/EIS. ðŸ›°

## Usage

Everything is performed by `eis_pointing.py`, which should be run from the
command line:

~~~
usage: eis_pointing.py [-h] [-c CORES] filename aia_band

Coregister EIS cube.

positional arguments:
  filename              the name of the level 0 EIS file, eg.
                        'eis_l0_20100815_192002'
  aia_band              the AIA band to use for the coalignment, eg. '193' --
                        CURRENTLY IGNORED, defaults to 193

optional arguments:
  -h, --help            show this help message and exit
  -c CORES, --cores CORES
                        maximum number of cores used for parallelisation
~~~

**Example:**

~~~
./eis_pointing.py -c16 eis_l0_20140810_042212 193
~~~

**Note:** in order for all components to work correctly, `eis_pointing.py` must
be run from the directory it is stored in, as shown in the example.

## Installation

1. Clone this repository.
2. Satisfy the following python dependencies: astropy, numpy, scipy,
   matplotlib, dateutil, pyyaml, [pySitools2], and [align_images].
3. If needed, install Solar Soft making sure that EIS is in the instrument list. If SSW
   is not installed in `/usr/local/ssw`, set the environment variable `SSW` to
   the appropriate path before running `eis_pointing.py`.

[pySitools2]: http://medocias.github.io/pySitools2_1.0/
[align_images]: https://git.ias.u-psud.fr/gpelouze/align_images


## Code structure

### Pipeline

`eis_pointing.py` performs all the following steps to determine the optimal
pointing data from EIS level 0 files.

1. `prep.pro` generates `eis_l1_<date>.fits` from `eis_l0_<date>.fits`. Both
   files are found in the EIS data files and directory structure described in
   EIS Software Note #18.

2. `export_windata.pro` generates `io/windata/eis_windata_<date>.sav` from the
   previously generated `eis_l1_<date>.fits`. This file contains a `windata`
   structure generated by `eis_getwindata`. (See EIS Software Note #21.)

3. `eis_aia_emission.py` sums the previously saved EIS windata in wavelength to
   generate an intensity map that can be compared to AIA images. Currently, the
   approach is to only sum the FE XII 195.119 Ã…. In the future, this step
   should use the AIA effective area to more accurately match the AIA emission.
   Data are saved to `io/eis_aia_emission/eis_aia_emission_<date>.fits`.

4. `eis_aia_registration.py` uses the AIA emission map generated at step 3, as
   well as AIA data retrieved from Medoc, to find the shift between EIS and
   AIA. Results from the alignment (ie. new EIS coordinates, and correlation
   cubes), are saved to `io/pointing/eis_pointing_<date>.fits`. At this step,
   diagnostics plots and a YAML file containing the results from the
   coregistration may also be saved to `io/pointing_verification/<date>_*`.

### Coregistration functions: `coregister/`

- `rasters.py` contains functions to register images in translation and
  rotation.
- `slits.py` functions to register slit positions (ie. vertical columns in an
  image) separately.

### Utility functions shared by different components `utils/`

- `aia_raster.py`: defines `AIARasterGenerator` that builds synthetic rasters
  from AIA data. Also contains `SimpleCache` and `FileCache`.
- `cli.py`: argument parsing and output display.
- `eis.py`, `aia.py`: functions to handle native EIS and AIA data, filenames,
  and data queries. This does not take care of transformed data such as
  `AIARasterGenerator`.
- `files.py`: manage local filenames (ie. those in `io/`); canonical EIS or AIA
  filenames are handled in `eis.py` or `aia.py`.
- `idl.py`: run IDL or SSW code from Python, load and format data returned by
  IDL. Contains `IDLFunction`, `SSWFunction` and `IDLStructure`.
- `num.py`: tools that extend numpy or scipy.
- `plots.py`: help generate plots at step 4.
- `sun.py`: generic solar computations.


## TODO

### Mandatory

- ~~refactor `utils.aia_raster`~~
- ~~refactor `utils.aia`~~
- ~~refactor `utils.eis`~~
- ~~implement functions to register images in rotation and translation in
  `coregister.rasters`, using components from [`align_images`].~~
- ~~implement functions to register slit positions separately in
  `coregister.slits`, using components from [`align_images`].~~
- ~~refactor `__main__` of `to_integrate/coregister_eis_aia.py` into
  `eis_pointing.compute_pointing`, using `coregister` submodules.~~
- ~~refactor `utils.plots`~~

### Optional

- ~~implement `utils.aia_raster.FileCache`~~
- ~~download EIS file from the MSSL archive if it is not found;Â this would
  require using `sol.data.eis.get_fits`.~~
- remove dependency on [`align_images`]

[`align_images`]: https://git.ias.u-psud.fr/gpelouze/align_images

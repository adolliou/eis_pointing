# EIS pointing

Tools to correct the pointing of Hinode/EIS. ðŸ›°

## Usage

Everything is performed by `eis_pointing.py`, which should be run from the
command line:

~~~
usage: eis_pointing.py [-h] [-s STEPS_FILE] [--io IO] [-c CORES]
                       filename [filename ...]


Determine the pointing of Hinode/EIS.

positional arguments:
  filename              The names of the level 0 EIS files, eg.
                        'eis_l0_20100815_192002'.

optional arguments:
  -h, --help            show this help message and exit
  -s STEPS_FILE, --steps-file STEPS_FILE
                        Path to a yaml file containing the registration steps.
  --io IO               Directory where output files are written,
						default: ./io.
  -c CORES, --cores CORES
                        Maximum number of cores used for parallelisation,
                        default: 4.
~~~

**Examples:**

~~~
./eis_pointing.py -c16 eis_l0_20140810_042212
./eis_pointing.py --steps-file steps/shift_only.yml eis_l0_20140810_042212
~~~

## Installation

1. Clone this repository.
2. Satisfy the following python dependencies: astropy, numpy, scipy,
   matplotlib, dateutil, pyyaml, [pySitools2], and [align_images].
3. If needed, install Solar Soft making sure that EIS is in the instrument list. If SSW
   is not installed in `/usr/local/ssw`, set the environment variable `SSW` to
   the appropriate path before running `eis_pointing.py`.

[pySitools2]: http://medocias.github.io/pySitools2_1.0/
[align_images]: https://git.ias.u-psud.fr/gpelouze/align_images

## Customisation

The registration steps used to find the optimal pointing can be customised in a
yaml file, and passed to `eis_pointing.py` using the parameter `--steps-file`.
The file should have a top-level key named `step`, containing a list of
registration steps. Each step must specify at least a `type`, chosen between
`shift`, `rotshift`, and `slitshift`.

By default, EIS data are coaligned with synthetic AIA raster. To coalign with a
single AIA image, add the top-level key `single_aia_frame: True`. In this case,
the reference AIA image chosen in the middle of the EIS raster.

See files in `steps/` for examples.

When no file is specified, the default behaviour is the same as using
`steps/full_registration.yml`.

## Code structure

### Pipeline

`eis_pointing.py` performs all the following steps to determine the optimal
pointing data from EIS level 0 files.

1. `prep.pro` generates `eis_l1_<date>.fits` from `eis_l0_<date>.fits`. Both
   files are found in the EIS data files and directory structure described in
   EIS Software Note #18.

2. `export_windata.pro` generates `io/windata/eis_windata_<date>.sav` from the
   previously generated `eis_l1_<date>.fits`. This file contains a `windata`
   structure generated by `eis_getwindata`. (See EIS Software Note #21.)

3. `eis_aia_emission.py` sums the previously saved EIS windata in wavelength to
   generate an intensity map of line Fe XII 195.119 Ã…. Data are saved to
   `io/eis_aia_emission/eis_aia_emission_<date>.fits`.

4. `eis_aia_registration.py` uses the emission map generated at step 3, as well
   as AIA 193 data retrieved from Medoc, to find the shift between EIS and AIA.
   Results from the alignment (ie. new EIS coordinates, and correlation cubes),
   are saved to `io/pointing/eis_pointing_<date>.fits`. At this step,
   diagnostics plots and a YAML file containing the results from the
   coregistration may also be saved to `io/pointing_verification/<date>_*`.

### Coregistration functions: `coregister/`

- `rasters.py` contains functions to register images in translation and
  rotation.
- `slits.py` functions to register slit positions (ie. vertical columns in an
  image) separately.

### Utility functions shared by different components `utils/`

- `aia_raster.py`: defines `AIARasterGenerator` that builds synthetic rasters
  from AIA data. Also contains `SimpleCache` and `FileCache`.
- `cli.py`: argument parsing and output display.
- `eis.py`, `aia.py`: functions to handle native EIS and AIA data, filenames,
  and data queries. This does not take care of transformed data such as
  `AIARasterGenerator`.
- `files.py`: manage local filenames (ie. those in `io/`); canonical EIS or AIA
  filenames are handled in `eis.py` or `aia.py`.
- `idl.py`: run IDL or SSW code from Python, load and format data returned by
  IDL. Contains `IDLFunction`, `SSWFunction` and `IDLStructure`.
- `num.py`: tools that extend numpy or scipy.
- `plots.py`: help generate plots at step 4.
- `sun.py`: generic solar computations.


## TODO

### Mandatory

- ~~refactor `utils.aia_raster`~~
- ~~refactor `utils.aia`~~
- ~~refactor `utils.eis`~~
- ~~implement functions to register images in rotation and translation in
  `coregister.rasters`, using components from [`align_images`].~~
- ~~implement functions to register slit positions separately in
  `coregister.slits`, using components from [`align_images`].~~
- ~~refactor `__main__` of `to_integrate/coregister_eis_aia.py` into
  `eis_pointing.compute_pointing`, using `coregister` submodules.~~
- ~~refactor `utils.plots`~~

### Optional

- ~~implement `utils.aia_raster.FileCache`~~
- ~~download EIS file from the MSSL archive if it is not found;Â this would
  require using `sol.data.eis.get_fits`.~~
- remove dependency on [`align_images`]

[`align_images`]: https://git.ias.u-psud.fr/gpelouze/align_images
